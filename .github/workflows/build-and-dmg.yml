name: Build macOS app and produce DMG

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-dmg:
    name: Build and create DMG
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: |
            build/DerivedData
            ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/SwiftBmo.xcodeproj/project.pbxproj') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Ensure build script is executable
        run: chmod +x scripts/build_and_dmg.sh

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run build_and_dmg script
        id: build_script
        run: |
          set -euxo pipefail
          # create output dir under build so it can be cached/collected
          mkdir -p build/dist
          # Run the project's build script. Adjust scheme/config as needed.
          bash scripts/build_and_dmg.sh -s SwiftBmo -c Release -o build/dist --clean

      - name: List dist contents
        run: |
          echo "Dist contents:"
          ls -la build/dist || true
          echo "DerivedData products:"
          ls -la build/DerivedData/Build/Products || true

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: SwiftBmo-dmg
          path: build/dist/*.dmg

      - name: Upload .app artifact (zipped)
        if: always()
        run: |
          set -euo pipefail
          APP_ZIP="build/SwiftBmo-app.zip"
          # find first .app in DerivedData products
          FOUND_APP=$(find build/DerivedData/Build/Products -maxdepth 4 -type d -name "*.app" | head -n 1 || true)
          if [[ -n "$FOUND_APP" ]]; then
            echo "Found app: $FOUND_APP"
            ditto -c -k --sequesterRsrc --keepParent "$FOUND_APP" "$APP_ZIP"
            echo "Zipped app to $APP_ZIP"
            gh-actions-upload-artifact-helper() { echo; }
          else
            echo "No .app found to upload"
          fi
        shell: bash

      - name: Upload zipped .app artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SwiftBmo-app-zip
          path: build/SwiftBmo-app.zip

      - name: Create GitHub Release for tag
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: "Automatic build + DMG generated by CI"
          draft: false
          prerelease: false

      - name: Upload DMG to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build/dist/SwiftBmo.dmg
          asset_name: SwiftBmo.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Cleanup potential secrets (placeholder)
        run: |
          echo "No secrets were added by this workflow. If you add signing artifacts (certs/profiles), remove them here."
        shell: bash

# Notes:
# - This workflow intentionally does NOT configure code signing or notarization. If you need signing,
#   add steps to import a certificate (from secrets) and a provisioning profile, and pass export options to the build script.
# - The script `scripts/build_and_dmg.sh` is used directly and will create the DMG at `build/dist/SwiftBmo.dmg` by default.
# - Adjust the scheme or project flags if your project layout changes.
